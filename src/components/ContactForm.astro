---
interface Props {
  type: 'contact' | 'inscription';
  preselectedModule?: string;
}

const { type, preselectedModule } = Astro.props;
const isInscription = type === 'inscription';

// Formulaires activés avec intégration Notion
const FORM_DISABLED = false;
---

<style>
  .sr-only {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border-width: 0;
  }
</style>

{FORM_DISABLED && (
  <div class="mb-6 p-6 bg-warm-100 border-l-4 border-terracotta-500 rounded-lg">
    <h3 class="text-lg font-semibold text-warm-800 mb-2">
      ⏳ Formulaires temporairement indisponibles
    </h3>
    <p class="text-warm-700 mb-2">
      Les formulaires sont actuellement en cours de configuration. 
      Ils seront bientôt disponibles pour recevoir tes messages et pré-inscriptions.
    </p>
    <p class="text-warm-700 text-sm">
      En attendant, tu peux toujours consulter toutes les informations sur les modules 
      et la pédagogie CDMC. Merci de ta compréhension !
    </p>
  </div>
)}

<form
  method="POST"
  action="#"
  class={`space-y-6 ${FORM_DISABLED ? 'opacity-50 pointer-events-none' : ''}`}
  data-form-type={type}
  aria-label={isInscription ? 'Formulaire de pré-inscription' : 'Formulaire de contact'}
  aria-disabled={FORM_DISABLED}
>
  <div>
    <label for={`${type}-name`} class="block text-warm-800 font-medium mb-2">
      Nom <span class="text-terracotta-600" aria-hidden="true">*</span>
      <span class="sr-only"> (requis)</span>
    </label>
    <input
      type="text"
      id={`${type}-name`}
      name="name"
      required
      aria-required="true"
      disabled={FORM_DISABLED}
      class="w-full px-4 py-2 border border-warm-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-terracotta-500 focus:border-transparent text-warm-900 disabled:bg-warm-200 disabled:cursor-not-allowed"
    />
  </div>

  <div>
    <label for={`${type}-email`} class="block text-warm-800 font-medium mb-2">
      Email <span class="text-terracotta-600" aria-hidden="true">*</span>
      <span class="sr-only"> (requis)</span>
    </label>
    <input
      type="email"
      id={`${type}-email`}
      name="email"
      required
      aria-required="true"
      disabled={FORM_DISABLED}
      class="w-full px-4 py-2 border border-warm-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-terracotta-500 focus:border-transparent text-warm-900 disabled:bg-warm-200 disabled:cursor-not-allowed"
    />
  </div>

  {isInscription ? (
    <>
      <div>
        <fieldset>
          <legend class="block text-warm-800 font-medium mb-2">
            Modules souhaités <span class="text-terracotta-600" aria-hidden="true">*</span>
            <span class="sr-only"> (requis)</span>
          </legend>
          <div class="space-y-2">
            <label class="flex items-center">
              <input
                type="checkbox"
                name="modules"
                value="theorie-debutant"
                disabled={FORM_DISABLED}
                class="mr-2 w-4 h-4 text-terracotta-600 focus:ring-terracotta-500 disabled:cursor-not-allowed"
                checked={preselectedModule === 'theorie-debutant'}
              />
              <span class="text-warm-700">Théorie Débutant</span>
            </label>
            <label class="flex items-center">
              <input
                type="checkbox"
                name="modules"
                value="theorie-intermediaire"
                disabled={FORM_DISABLED}
                class="mr-2 w-4 h-4 text-terracotta-600 focus:ring-terracotta-500 disabled:cursor-not-allowed"
                checked={preselectedModule === 'theorie-intermediaire'}
              />
              <span class="text-warm-700">Théorie Intermédiaire</span>
            </label>
            <label class="flex items-center">
              <input
                type="checkbox"
                name="modules"
                value="theorie-avancee"
                disabled={FORM_DISABLED}
                class="mr-2 w-4 h-4 text-terracotta-600 focus:ring-terracotta-500 disabled:cursor-not-allowed"
                checked={preselectedModule === 'theorie-avancee'}
              />
              <span class="text-warm-700">Théorie Avancée</span>
            </label>
            <label class="flex items-center">
              <input
                type="checkbox"
                name="modules"
                value="mao"
                disabled={FORM_DISABLED}
                class="mr-2 w-4 h-4 text-terracotta-600 focus:ring-terracotta-500 disabled:cursor-not-allowed"
                checked={preselectedModule === 'mao'}
              />
              <span class="text-warm-700">MAO</span>
            </label>
            <label class="flex items-center">
              <input
                type="checkbox"
                name="modules"
                value="piano"
                disabled={FORM_DISABLED}
                class="mr-2 w-4 h-4 text-terracotta-600 focus:ring-terracotta-500 disabled:cursor-not-allowed"
                checked={preselectedModule === 'piano'}
              />
              <span class="text-warm-700">Piano</span>
            </label>
            <label class="flex items-center">
              <input
                type="checkbox"
                name="modules"
                value="rythmique"
                disabled={FORM_DISABLED}
                class="mr-2 w-4 h-4 text-terracotta-600 focus:ring-terracotta-500 disabled:cursor-not-allowed"
                checked={preselectedModule === 'rythmique'}
              />
              <span class="text-warm-700">Rythmique</span>
            </label>
          </div>
        </fieldset>
      </div>

      <div>
        <label for={`${type}-comment`} class="block text-warm-800 font-medium mb-2">
          Commentaire (optionnel)
        </label>
        <textarea
          id={`${type}-comment`}
          name="comment"
          rows="4"
          disabled={FORM_DISABLED}
          class="w-full px-4 py-2 border border-warm-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-terracotta-500 focus:border-transparent text-warm-900 disabled:bg-warm-200 disabled:cursor-not-allowed"
        ></textarea>
      </div>
    </>
  ) : (
    <div>
      <label for={`${type}-message`} class="block text-warm-800 font-medium mb-2">
        Message <span class="text-terracotta-600" aria-hidden="true">*</span>
        <span class="sr-only"> (requis)</span>
      </label>
      <textarea
        id={`${type}-message`}
        name="message"
        required
        aria-required="true"
        rows="6"
        disabled={FORM_DISABLED}
        class="w-full px-4 py-2 border border-warm-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-terracotta-500 focus:border-transparent text-warm-900 disabled:bg-warm-200 disabled:cursor-not-allowed"
      ></textarea>
    </div>
  )}

  <div id={`${type}-message`} role="alert" aria-live="polite" class="hidden mb-4"></div>

  <button
    type="submit"
    id={`${type}-submit`}
    disabled={FORM_DISABLED}
    class="w-full md:w-auto px-6 py-3 bg-terracotta-600 text-white rounded-lg font-semibold hover:bg-terracotta-700 focus:outline-none focus:ring-2 focus:ring-terracotta-500 focus:ring-offset-2 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
  >
    <span id={`${type}-submit-text`}>
      {isInscription ? 'Envoyer ma pré-inscription' : 'Envoyer le message'}
    </span>
    <span id={`${type}-submit-loading`} class="hidden">Envoi en cours...</span>
  </button>
</form>

      <script define:vars={{ formType: type, formDisabled: FORM_DISABLED }}>
        // Fonction pour initialiser le formulaire
        function initForm() {
          const form = document.querySelector(`form[data-form-type="${formType}"]`);
          const messageDiv = document.getElementById(`${formType}-message`);
          const submitButton = document.getElementById(`${formType}-submit`);
          const submitText = document.getElementById(`${formType}-submit-text`);
          const submitLoading = document.getElementById(`${formType}-submit-loading`);

          if (form && messageDiv && submitButton && submitText && submitLoading && !formDisabled) {
            form.addEventListener('submit', async (e) => {
              e.preventDefault();

              // Réinitialiser les messages
              messageDiv.classList.add('hidden');
              messageDiv.className = 'hidden mb-4';
              submitButton.disabled = true;
              submitText.classList.add('hidden');
              submitLoading.classList.remove('hidden');

              // Convertir le FormData en objet JSON
              const formData = new FormData(form);
              const requestData = {};
              for (const [key, value] of formData.entries()) {
                if (key === 'modules') {
                  // Pour les modules (checkboxes), créer un tableau
                  if (!requestData[key]) {
                    requestData[key] = [];
                  }
                  requestData[key].push(value);
                } else {
                  requestData[key] = value;
                }
              }
              
              const apiEndpoint = formType === 'inscription' ? '/api/inscription' : '/api/contact';

              try {
                const response = await fetch(apiEndpoint, {
                  method: 'POST',
                  headers: {
                    'Content-Type': 'application/json',
                  },
                  body: JSON.stringify(requestData),
                });

                const responseData = await response.json();

                if (responseData.success) {
                  // Succès
                  messageDiv.className = 'mb-4 p-4 bg-green-100 border border-green-400 text-green-800 rounded-lg';
                  messageDiv.textContent = responseData.message || 'Message envoyé avec succès !';
                  messageDiv.classList.remove('hidden');
                  form.reset();
                } else {
                  // Erreur
                  messageDiv.className = 'mb-4 p-4 bg-red-100 border border-red-400 text-red-800 rounded-lg';
                  messageDiv.textContent = responseData.error || 'Une erreur est survenue.';
                  messageDiv.classList.remove('hidden');
                }
              } catch (error) {
                // Erreur réseau
                console.error('Erreur lors de l\'envoi du formulaire:', error);
                messageDiv.className = 'mb-4 p-4 bg-red-100 border border-red-400 text-red-800 rounded-lg';
                messageDiv.textContent = 'Une erreur est survenue lors de l\'envoi. Veuillez réessayer.';
                messageDiv.classList.remove('hidden');
              } finally {
                submitButton.disabled = false;
                submitText.classList.remove('hidden');
                submitLoading.classList.add('hidden');
              }
            });
          } else {
            console.warn('Form elements not found or form is disabled', {
              form: !!form,
              messageDiv: !!messageDiv,
              submitButton: !!submitButton,
              submitText: !!submitText,
              submitLoading: !!submitLoading,
              formDisabled: formDisabled,
              formType: formType
            });
          }
        }

        // Initialiser immédiatement si le DOM est déjà chargé, sinon attendre
        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', initForm);
        } else {
          initForm();
        }
</script>

